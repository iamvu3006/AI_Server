<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K·∫øt Qu·∫£ Nh·∫≠n Di·ªán L√° C√¢y</title>
    <link rel="stylesheet" href="style.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            padding: 0;
        }

        .container {
            max-width: 1400px;
            margin: 20px auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #7f8c8d;
            margin-bottom: 30px;
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 14px;
            color: #555;
            font-weight: 600;
        }

        input[type="date"],
        input[type="time"],
        select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            margin-top: auto;
        }

        .btn-filter {
            background: #3498db;
            color: white;
        }

        .btn-reset {
            background: #95a5a6;
            color: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th {
            background: #34495e;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #ecf0f1;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .image-cell {
            width: 150px;
        }

        .thumbnail {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .thumbnail:hover {
            transform: scale(1.05);
        }

        .status-healthy {
            color: #27ae60;
            font-weight: bold;
        }

        .status-diseased {
            color: #e74c3c;
            font-weight: bold;
        }

        .confidence {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: 600;
        }

        .conf-high {
            background: #d4edda;
            color: #155724;
        }

        .conf-medium {
            background: #fff3cd;
            color: #856404;
        }

        .conf-low {
            background: #f8d7da;
            color: #721c24;
        }

        /* Modal for full image */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
        }

        .modal-content {
            margin: auto;
            display: block;
            max-width: 90%;
            max-height: 90%;
            margin-top: 50px;
        }

        .close {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <header>
        <nav>
            <ul>
                <li><a href="index.html">Dashboard</a></li>
                <li><a href="index.html#notifications">Xem Th√¥ng B√°o</a></li>
                <li><a href="results.html" style="color: #4CAF50;">AI nh·∫≠n d·∫°ng l√°</a></li>
                <li><a href="index.html#thresholds">Ch·ªânh S·ª≠a Ng∆∞·ª°ng</a></li>
                <li><span id="connectionStatus" class="connection-status">ƒê√£ K·∫øt N·ªëi V·ªõi Thi·∫øt B·ªã.</span></li>
            </ul>
        </nav>
    </header>

    <div class="container">
        <h1>üçÉ K·∫øt Qu·∫£ Nh·∫≠n Di·ªán L√° T·ª´ AI</h1>
        <p class="subtitle">D·ªØ li·ªáu th·ªùi gian th·ª±c t·ª´ ESP32-CAM</p>

        <!-- Statistics -->
        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalCount">0</div>
                <div class="stat-label">T·ªïng s·ªë m·∫´u</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="healthyCount">0</div>
                <div class="stat-label">L√° kh·ªèe m·∫°nh</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="diseasedCount">0</div>
                <div class="stat-label">L√° b·ªánh</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgConf">0%</div>
                <div class="stat-label">ƒê·ªô tin c·∫≠y TB</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters">
            <div class="filter-group">
                <label>Ng√†y:</label>
                <input type="date" id="filterDate">
            </div>
            <div class="filter-group">
                <label>T·ª´ gi·ªù:</label>
                <input type="time" id="filterTimeFrom">
            </div>
            <div class="filter-group">
                <label>ƒê·∫øn gi·ªù:</label>
                <input type="time" id="filterTimeTo">
            </div>
            <div class="filter-group">
                <label>Tr·∫°ng th√°i:</label>
                <select id="filterStatus">
                    <option value="">T·∫•t c·∫£</option>
                    <option value="healthy">Kh·ªèe m·∫°nh</option>
                    <option value="diseased">B·ªánh</option>
                </select>
            </div>
            <button class="btn btn-filter" onclick="applyFilter()">L·ªçc</button>
            <button class="btn btn-reset" onclick="resetFilter()">ƒê·∫∑t l·∫°i</button>
        </div>

        <!-- Loading -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
        </div>

        <!-- Table -->
        <table id="dataTable" style="display: none;">
            <thead>
                <tr>
                    <th>H√¨nh ·∫¢nh</th>
                    <th>Th·ªùi Gian</th>
                    <th>Tr·∫°ng Th√°i</th>
                    <th>ƒê·ªô Tin C·∫≠y</th>
                    <th>T√™n File</th>
                </tr>
            </thead>
            <tbody id="tableBody">
            </tbody>
        </table>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" class="modal" onclick="closeModal()">
        <span class="close">&times;</span>
        <img class="modal-content" id="modalImage">
    </div>

    <script>
        const AI_SERVER = 'http://192.168.1.15:5000'; // Thay b·∫±ng IP server c·ªßa b·∫°n
        let allData = [];

        // Load data when page loads
        window.onload = function() {
            loadData();
            setInterval(loadData, 10000); // Refresh every 10 seconds
        };

        async function loadData() {
            try {
                const response = await fetch(`${AI_SERVER}/images`);
                const data = await response.json();
                
                // Parse filenames to create data array
                allData = data.images.map(filename => {
                    // Format: 20251114_163034_healthy_95.jpg
                    const parts = filename.replace('.jpg', '').split('_');
                    
                    const date = parts[0]; // YYYYMMDD
                    const time = parts[1]; // HHMMSS
                    
                    // Format date: DD/MM/YYYY
                    const formattedDate = `${date.substr(6,2)}/${date.substr(4,2)}/${date.substr(0,4)}`;
                    // Format time: HH:MM:SS
                    const formattedTime = `${time.substr(0,2)}:${time.substr(2,2)}:${time.substr(4,2)}`;
                    
                    return {
                        date: date,
                        time: time,
                        datetime: `${formattedDate} ${formattedTime}`,
                        status: parts[2],
                        confidence: parseInt(parts[3]),
                        filename: filename,
                        imageUrl: `${AI_SERVER}/images/${filename}`
                    };
                });
                
                // Sort by datetime (newest first)
                allData.sort((a, b) => b.date + b.time - (a.date + a.time));
                
                updateStats();
                displayData(allData);
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loading').innerHTML = 
                    '<p style="color: red;">‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server AI</p>';
            }
        }

        function updateStats() {
            const total = allData.length;
            const healthy = allData.filter(d => d.status === 'healthy').length;
            const diseased = total - healthy;
            const avgConf = total > 0 ? 
                Math.round(allData.reduce((sum, d) => sum + d.confidence, 0) / total) : 0;
            
            document.getElementById('totalCount').textContent = total;
            document.getElementById('healthyCount').textContent = healthy;
            document.getElementById('diseasedCount').textContent = diseased;
            document.getElementById('avgConf').textContent = avgConf + '%';
        }

        function displayData(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
            }
            
            data.forEach(item => {
                const row = document.createElement('tr');
                
                // Image cell
                const imgCell = document.createElement('td');
                imgCell.className = 'image-cell';
                const img = document.createElement('img');
                img.src = item.imageUrl;
                img.className = 'thumbnail';
                img.alt = item.status;
                img.onclick = () => openModal(item.imageUrl);
                imgCell.appendChild(img);
                
                // Datetime cell
                const dateCell = document.createElement('td');
                dateCell.textContent = item.datetime;
                
                // Status cell
                const statusCell = document.createElement('td');
                statusCell.className = item.status === 'healthy' ? 'status-healthy' : 'status-diseased';
                statusCell.textContent = item.status === 'healthy' ? 'üü¢ Kh·ªèe m·∫°nh' : 'üî¥ B·ªánh';
                
                // Confidence cell
                const confCell = document.createElement('td');
                const confSpan = document.createElement('span');
                confSpan.className = 'confidence';
                if (item.confidence >= 80) confSpan.className += ' conf-high';
                else if (item.confidence >= 60) confSpan.className += ' conf-medium';
                else confSpan.className += ' conf-low';
                confSpan.textContent = item.confidence + '%';
                confCell.appendChild(confSpan);
                
                // Filename cell
                const fileCell = document.createElement('td');
                fileCell.textContent = item.filename;
                fileCell.style.fontSize = '12px';
                fileCell.style.color = '#7f8c8d';
                
                row.appendChild(imgCell);
                row.appendChild(dateCell);
                row.appendChild(statusCell);
                row.appendChild(confCell);
                row.appendChild(fileCell);
                
                tbody.appendChild(row);
            });
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dataTable').style.display = 'table';
        }

        function applyFilter() {
            const date = document.getElementById('filterDate').value;
            const timeFrom = document.getElementById('filterTimeFrom').value;
            const timeTo = document.getElementById('filterTimeTo').value;
            const status = document.getElementById('filterStatus').value;
            
            let filtered = allData;
            
            if (date) {
                const filterDate = date.replace(/-/g, '');
                filtered = filtered.filter(item => item.date === filterDate);
            }
            
            if (timeFrom) {
                const filterTime = timeFrom.replace(/:/g, '');
                filtered = filtered.filter(item => item.time >= filterTime);
            }
            
            if (timeTo) {
                const filterTime = timeTo.replace(/:/g, '');
                filtered = filtered.filter(item => item.time <= filterTime);
            }
            
            if (status) {
                filtered = filtered.filter(item => item.status === status);
            }
            
            displayData(filtered);
        }

        function resetFilter() {
            document.getElementById('filterDate').value = '';
            document.getElementById('filterTimeFrom').value = '';
            document.getElementById('filterTimeTo').value = '';
            document.getElementById('filterStatus').value = '';
            displayData(allData);
        }

        function openModal(imageUrl) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modal.style.display = 'block';
            modalImg.src = imageUrl;
        }

        function closeModal() {
            document.getElementById('imageModal').style.display = 'none';
        }
    </script>
</body>
</html>